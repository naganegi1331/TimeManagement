# Family Controls認証トラブルシューティング

## 🔧 認証が失敗する場合の対処法

### 1. デバイス設定の確認

**スクリーンタイム設定:**
```
設定 → スクリーンタイム → スクリーンタイムをオンにする
```

**制限とプライバシー:**
```
設定 → スクリーンタイム → コンテンツとプライバシーの制限 → オン
```

### 2. Apple ID設定の確認

**サインイン状態:**
```
設定 → [あなたの名前] → Apple IDにサインインしていることを確認
```

**Family Sharing:**
```
設定 → [あなたの名前] → ファミリー共有 → 設定済みであることを確認
```

### 3. アプリ権限のリセット

**設定をリセット:**
```
設定 → 一般 → リセット → プライバシーと位置情報の設定をリセット
```

### 4. 開発者向け設定

**信頼できる開発者:**
```
設定 → 一般 → VPNとデバイス管理 → 開発者アプリ → [開発者名] → 信頼
```

## 🚨 よくあるエラーと解決法

### エラー: "Authorization request failed"

**原因と解決法:**
1. **スクリーンタイムが無効**
   - 設定 → スクリーンタイム → オンにする

2. **Apple IDサインアウト状態**
   - 設定 → [あなたの名前] → サインイン

3. **ネットワーク接続問題**
   - Wi-Fi/モバイルデータ接続を確認

### エラー: "process may not map database"

**解決法:**
1. **アプリを完全終了**
   - ホームボタン2回押し → アプリを上にスワイプ

2. **デバイス再起動**
   - 電源ボタン長押し → 再起動

3. **Xcodeでクリーンビルド**
   ```bash
   Product → Clean Build Folder
   ```

## 📱 実機テスト手順

### 1. 認証前の状態確認
- [ ] アプリを起動
- [ ] 分析画面に移動
- [ ] 「認証が必要です」メッセージを確認

### 2. 認証実行
- [ ] 「詳細なデバイス使用時間を確認」をタップ
- [ ] 「認証を試行」ボタンをタップ
- [ ] システムダイアログで「許可」をタップ

### 3. 認証後の動作確認
- [ ] DeviceActivityReportが表示される
- [ ] 実際のアプリ使用時間データが表示される
- [ ] エラーメッセージが消える

## 🔍 デバッグ情報

### ログの確認
```swift
print("Authorization Status: \(authorizationCenter.authorizationStatus)")
```

### 認証状態の種類
- `.notDetermined`: 未決定
- `.denied`: 拒否
- `.approved`: 承認済み

### コンソールログの確認
Xcodeのコンソールで以下のログを確認：
```
Authorization request failed: [エラー詳細]
``` 